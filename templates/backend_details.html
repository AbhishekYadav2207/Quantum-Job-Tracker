{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block icon %}bi-server{% endblock %}
{% block page_title %}Backend Details{% endblock %}
{% block subtitle %}Detailed information about {{ backend_name }}{% endblock %}

{% block header_actions %}
<a href="{{ url_for('backends') }}" class="btn btn-outline-secondary me-2">
  <i class="bi bi-arrow-left me-1"></i>Back to Backends
</a>
<a href="{{ url_for('backend_analytics', backend_name=backend_name) }}" class="btn btn-info me-2">
  <i class="bi bi-bar-chart me-1"></i>View Analytics
</a>
<button class="btn btn-primary" onclick="refreshBackendData()">
  <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
</button>
{% endblock %}

{% block content %}
<style>
/* General Card Styles */
.card {
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border: none;
  overflow: hidden;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}
.card-header {
  border-bottom: 1px solid rgba(0,0,0,0.06);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Quantum Hardware Section Specific Styles */
.hardware-section {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.hardware-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
}

.hardware-column {
  background: white;
  border-radius: 10px;
  padding: 1.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border: 1px solid rgba(0,0,0,0.08);
}

.hardware-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid #3498db;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.hardware-title i {
  color: #3498db;
}

.metric-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.75rem;
  border: 1px solid rgba(0,0,0,0.06);
  transition: all 0.2s ease;
}

.metric-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.metric-header {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.metric-label {
  font-size: 0.9rem;
  font-weight: 500;
  color: #6c757d;
  flex: 1;
}

.metric-value {
  font-size: 1.1rem;
  font-weight: 700;
  color: #2c3e50;
  text-align: right;
}

.metric-description {
  font-size: 0.8rem;
  color: #95a5a6;
  margin-top: 0.25rem;
}

.status-badge {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.9rem;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.system-info {
  background: #e8f4fd;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.75rem;
}

.system-info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px solid rgba(52, 152, 219, 0.2);
}

.system-info-item:last-child {
  border-bottom: none;
}

.system-info-label {
  font-size: 0.9rem;
  color: #2c3e50;
  font-weight: 500;
}

.system-info-value {
  font-size: 0.9rem;
  color: #3498db;
  font-weight: 600;
}

.basis-gates-container {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 10px;
  padding: 1.5rem;
  margin-top: 1.5rem;
}

.basis-gates-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 1rem;
  text-align: center;
}

.basis-gates-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  gap: 0.75rem;
}

.gate-badge {
  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
  color: white;
  padding: 0.5rem;
  border-radius: 6px;
  text-align: center;
  font-weight: 600;
  font-size: 0.85rem;
  transition: all 0.2s ease;
}

.gate-badge:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* Performance metric specific colors */
.metric-error {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: white;
}

.metric-warning {
  background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
  color: #212529;
}

.metric-success {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
}

.metric-info {
  background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
  color: white;
}

.metric-primary {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .hardware-grid {
    grid-template-columns: 1fr;
  }

  .hardware-column {
    padding: 1rem;
  }

  .basis-gates-grid {
    grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
  }
}
</style>

<div class="row">
  <!-- Basic Information -->
  <div class="col-lg-4 mb-4">
    <div class="card h-100">
      <div class="card-header bg-primary text-white">
        <i class="bi bi-info-circle me-2"></i>Basic Information
      </div>
      <div class="card-body">
        {% if backend %}
        <div class="text-center mb-4">
          <div class="bg-primary bg-gradient rounded-circle p-4 d-inline-block mb-3">
            <i class="bi bi-cpu display-4 text-white"></i>
          </div>
          <h3>{{ backend_name }}</h3>
          <span class="badge bg-{% if backend.status and backend.status.operational %}success{% else %}danger{% endif %}">
            {% if backend.status and backend.status.operational %}Operational{% else %}Offline{% endif %}
          </span>
        </div>

        <div class="row">
          <div class="col-6">
            <strong>Qubits:</strong>
          </div>
          <div class="col-6">
            {{ backend.n_qubits if backend.n_qubits and backend.n_qubits != 'Unknown' else 'N/A' }}
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-6">
            <strong>Version:</strong>
          </div>
          <div class="col-6">
            {{ backend.backend_version if backend.backend_version and backend.backend_version != 'Unknown' else 'N/A' }}
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-6">
            <strong>Simulator:</strong>
          </div>
          <div class="col-6">
            {% if backend.simulator %}Yes{% else %}No{% endif %}
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-6">
            <strong>Pending Jobs:</strong>
          </div>
          <div class="col-6">
            {{ backend.status.pending_jobs if backend.status and backend.status.pending_jobs != 'N/A' else 'N/A' }}
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-6">
            <strong>Queue Position:</strong>
          </div>
          <div class="col-6">
            {{ backend.status.queue_position if backend.status and backend.status.queue_position != 'N/A' else 'N/A' }}
          </div>
        </div>

        {% if backend.description %}
        <div class="mt-3">
          <strong>Description:</strong>
          <p class="text-muted small">{{ backend.description }}</p>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center text-muted py-4">
          <i class="bi bi-exclamation-circle display-4"></i>
          <p>No backend data available</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Configuration Details -->
  <div class="col-lg-8 mb-4">
    <div class="card">
      <div class="card-header bg-info text-white">
        <i class="bi bi-gear me-2"></i>Configuration Details
      </div>
      <div class="card-body">
        {% if backend and backend.configuration %}
        <div class="row">
          <div class="col-md-6">
            <h6>Basic Properties</h6>
            <table class="table table-sm">
              <tr>
                <td><strong>Max Shots:</strong></td>
                <td>{{ backend.configuration.max_shots if backend.configuration.max_shots and backend.configuration.max_shots != 'N/A' else 'N/A' }}</td>
              </tr>
              <tr>
                <td><strong>Max Experiments:</strong></td>
                <td>{{ backend.configuration.max_experiments if backend.configuration.max_experiments and backend.configuration.max_experiments != 'N/A' else 'N/A' }}</td>
              </tr>
              <tr>
                <td><strong>Memory:</strong></td>
                <td>{{ 'Yes' if backend.configuration.memory else 'No' }}</td>
              </tr>
              {% if backend.configuration.sample_name %}
              <tr>
                <td><strong>Sample Name:</strong></td>
                <td>{{ backend.configuration.sample_name }}</td>
              </tr>
              {% endif %}
            </table>
          </div>

          <div class="col-md-6">
            <h6>Timing Information</h6>
            <table class="table table-sm">
              {% if backend.configuration.rep_times and backend.configuration.rep_times|length > 0 %}
              <tr>
                <td><strong>Repetition Times:</strong></td>
                <td>{{ backend.configuration.rep_times|join(', ') }}</td>
              </tr>
              {% endif %}
              <tr>
                <td><strong>Default Rep Time:</strong></td>
                <td>
                  {% if backend.configuration.default_rep_time and backend.configuration.default_rep_time != 'N/A' %}
                    {{ "%.3f"|format(backend.configuration.default_rep_time) }} μs
                  {% else %}
                    N/A
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>Min Rep Time:</strong></td>
                <td>
                  {% if backend.configuration.min_rep_time and backend.configuration.min_rep_time != 'N/A' %}
                    {{ "%.3f"|format(backend.configuration.min_rep_time) }} μs
                  {% else %}
                    N/A
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>Max Rep Time:</strong></td>
                <td>
                  {% if backend.configuration.max_rep_time and backend.configuration.max_rep_time != 'N/A' %}
                    {{ "%.3f"|format(backend.configuration.max_rep_time) }} μs
                  {% else %}
                    N/A
                  {% endif %}
                </td>
              </tr>
            </table>
          </div>
        </div>

        {% if backend.configuration.basis_gates and backend.configuration.basis_gates|length > 0 %}
        <div class="mt-3">
          <h6>Basis Gates</h6>
          <div class="d-flex flex-wrap gap-1">
            {% for gate in backend.configuration.basis_gates %}
            <span class="badge bg-secondary">{{ gate }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center text-muted py-4">
          <i class="bi bi-gear display-4"></i>
          <p>No configuration data available</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Performance Metrics -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-dark text-white">
        <i class="bi bi-speedometer2 me-2"></i>Performance Metrics
      </div>
      <div class="card-body">
        {% if backend and backend.status %}
        <div class="row text-center">
          <div class="col-md-3 mb-3">
            <div class="card bg-light">
              <div class="card-body">
                <h5 class="card-title">{{ backend.status.pending_jobs if backend.status.pending_jobs != 'N/A' else 0 }}</h5>
                <p class="card-text">Pending Jobs</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card bg-light">
              <div class="card-body">
                <h5 class="card-title">{{ backend.status.queue_position if backend.status.queue_position != 'N/A' else 'N/A' }}</h5>
                <p class="card-text">Queue Position</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card bg-light">
              <div class="card-body">
                <h5 class="card-title">
                  {% if backend.status.operational %}Online{% else %}Offline{% endif %}
                </h5>
                <p class="card-text">Status</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card bg-light">
              <div class="card-body">
                <h5 class="card-title">{{ backend.n_qubits if backend.n_qubits and backend.n_qubits != 'Unknown' else 'N/A' }}</h5>
                <p class="card-text">Qubits</p>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
          <i class="bi bi-speedometer2 display-4"></i>
          <p>No performance metrics available</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Quantum Hardware Details -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-success text-white">
        <i class="bi bi-cpu me-2"></i>Quantum Hardware Details
      </div>
      <div class="card-body">
        <!-- Status Badge -->
        <div class="status-badge">
          <i class="bi bi-circle-fill"></i> Online - Operational
        </div>

        <div class="hardware-grid">
          <!-- Column 1: Qubit Information -->
          <div class="hardware-column">
            <div class="hardware-title">
              <i class="bi bi-grid-3x3-gap"></i> Qubit Information
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Total Qubits</span>
                <span class="metric-value">133</span>
              </div>
            </div>

            <div class="metric-card metric-error">
              <div class="metric-header">
                <span class="metric-label">2Q Error (best)</span>
                <span class="metric-value">1.50E-3</span>
              </div>
              <div class="metric-description">Best two-qubit gate error rate</div>
            </div>

            <div class="metric-card metric-warning">
              <div class="metric-header">
                <span class="metric-label">2Q Error (layered)</span>
                <span class="metric-value">7.56E-3</span>
              </div>
              <div class="metric-description">Layered two-qubit gate error rate</div>
            </div>

            <div class="metric-card metric-info">
              <div class="metric-header">
                <span class="metric-label">CLOPS</span>
                <span class="metric-value">210K</span>
              </div>
              <div class="metric-description">Circuit Layer Operations Per Second</div>
            </div>
          </div>

          <!-- Column 2: System Information -->
          <div class="hardware-column">
            <div class="hardware-title">
              <i class="bi bi-hdd-stack"></i> System Information
            </div>

            <div class="system-info">
              <div class="system-info-item">
                <span class="system-info-label">Status</span>
                <span class="system-info-value">Online</span>
              </div>
              <div class="system-info-item">
                <span class="system-info-label">Region</span>
                <span class="system-info-value">Washington DC (us-east)</span>
              </div>
              <div class="system-info-item">
                <span class="system-info-label">QPU Version</span>
                <span class="system-info-value">1.0.85</span>
              </div>
              <div class="system-info-item">
                <span class="system-info-label">Processor Type</span>
                <span class="system-info-value">Heron r1</span>
              </div>
            </div>
          </div>

          <!-- Column 3: Performance Metrics -->
          <div class="hardware-column">
            <div class="hardware-title">
              <i class="bi bi-graph-up"></i> Performance Metrics
            </div>

            <div class="metric-card metric-error">
              <div class="metric-header">
                <span class="metric-label">Median CZ Error</span>
                <span class="metric-value">2.856E-3</span>
              </div>
            </div>

            <div class="metric-card metric-error">
              <div class="metric-header">
                <span class="metric-label">Median SX Error</span>
                <span class="metric-value">3.3E-4</span>
              </div>
            </div>

            <div class="metric-card metric-error">
              <div class="metric-header">
                <span class="metric-label">Median Readout Error</span>
                <span class="metric-value">2.905E-2</span>
              </div>
            </div>

            <div class="metric-card metric-primary">
              <div class="metric-header">
                <span class="metric-label">Median T1</span>
                <span class="metric-value">177.31 μs</span>
              </div>
            </div>

            <div class="metric-card metric-primary">
              <div class="metric-header">
                <span class="metric-label">Median T2</span>
                <span class="metric-value">134.96 μs</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Basis Gates -->
        <div class="basis-gates-container">
          <div class="basis-gates-title">
            <i class="bi bi-code-slash me-2"></i> Basis Gates
          </div>
          <div class="basis-gates-grid">
            <span class="gate-badge">cz</span>
            <span class="gate-badge">id</span>
            <span class="gate-badge">rx</span>
            <span class="gate-badge">rz</span>
            <span class="gate-badge">rzz</span>
            <span class="gate-badge">sx</span>
            <span class="gate-badge">x</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Calibration Data -->
<div class="row">
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
        <div>
          <i class="bi bi-graph-up me-2"></i>Calibration Data
        </div>
        <a href="{{ url_for('backend_analytics', backend_name=backend_name) }}" class="btn btn-primary btn-sm">
          <i class="bi bi-bar-chart me-1"></i>View Full Analytics
        </a>
      </div>
      <div class="card-body">
        {% if calibration and calibration.qubits %}
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          For detailed calibration analytics and visualizations, click the "View Full Analytics" button above.
        </div>

        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-sm table-hover">
            <thead class="table-light">
              <tr>
                <th>Qubit</th>
                <th>T1 (μs)</th>
                <th>T2 (μs)</th>
                <th>Readout Error</th>
                <th>Frequency (GHz)</th>
              </tr>
            </thead>
            <tbody>
              {% for qubit, data in calibration.qubits.items() %}
              <tr>
                <td><strong>{{ qubit }}</strong></td>
                <td>
                  {% if data.T1 and data.T1.value is not none %}
                    {{ "%.2f"|format(data.T1.value) }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  {% if data.T2 and data.T2.value is not none %}
                    {{ "%.2f"|format(data.T2.value) }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  {% if data.readout_error and data.readout_error.value is not none %}
                    {{ "%.4f"|format(data.readout_error.value) }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  {% if data.frequency and data.frequency.value is not none %}
                    {{ "%.4f"|format(data.frequency.value) }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
          <i class="bi bi-graph-up display-4"></i>
          <p>No calibration data available</p>
          <a href="{{ url_for('backend_analytics', backend_name=backend_name) }}" class="btn btn-primary mt-2">
            <i class="bi bi-bar-chart me-1"></i>Check Analytics
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshBackendData() {
  window.location.reload();
}

// Load backend data periodically
setInterval(function() {
  fetch(`/api/backend/{{ backend_name }}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        console.log('Backend data updated', data.backend);
        // You could implement live updates here
      }
    })
    .catch(error => console.error('Error fetching backend data:', error));
}, 30000); // Update every 30 seconds
</script>
{% endblock %}