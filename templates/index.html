<!-- [file name]: templates/index.html -->
<!-- [file content begin] -->
{% extends "base.html" %}
{% block title %}Dashboard - Quantum Job Tracker{% endblock %}
{% block icon %}bi-speedometer2{% endblock %}
{% block page_title %}Quantum Dashboard{% endblock %}
{% block subtitle %}Monitor and submit quantum computing jobs{% endblock %}

{% block header_actions %}
<div class="btn-group">
  <a href="{{ url_for('jobs') }}" class="btn btn-outline-primary">
    <i class="bi bi-list-task me-1"></i>View Jobs
  </a>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#jobModal">
    <i class="bi bi-plus-circle me-1"></i>New Job
  </button>
</div>
{% endblock %}

{% block content %}
<!-- System Status Alerts -->
{% if service_error %}
<div class="alert alert-warning">
  <i class="bi bi-exclamation-triangle me-2"></i>
  <strong>Service Notice:</strong> {{ service_error }}
</div>
{% endif %}

<div class="alert alert-info">
  <i class="bi bi-info-circle me-2"></i>
  <strong>Open Plan Mode:</strong> Using direct circuit execution compatible with IBM Quantum free tier.
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="card card-hover h-100">
      <div class="card-body text-center">
        <div class="text-primary mb-2">
          <i class="bi bi-server fs-1"></i>
        </div>
        <h3 class="card-title">{{ public_backends|length + private_backends|length }}</h3>
        <p class="card-text text-muted">Available Backends</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card card-hover h-100">
      <div class="card-body text-center">
        <div class="text-success mb-2">
          <i class="bi bi-check-circle fs-1"></i>
        </div>
        <h3 class="card-title">{{ public_backends|length }}</h3>
        <p class="card-text text-muted">Public Backends</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card card-hover h-100">
      <div class="card-body text-center">
        <div class="text-info mb-2">
          <i class="bi bi-cloud fs-1"></i>
        </div>
        <h3 class="card-title">{{ private_backends|length }}</h3>
        <p class="card-text text-muted">Private Backends</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card card-hover h-100">
      <div class="card-body text-center">
        <div class="text-warning mb-2">
          <i class="bi bi-lightning-charge fs-1"></i>
        </div>
        <h3 class="card-title">
          {% if least_busy %}{{ least_busy.queue }}{% else %}0{% endif %}
        </h3>
        <p class="card-text text-muted">Min Queue Length</p>
      </div>
    </div>
  </div>
</div>

<!-- Backend Recommendations -->
{% if recommendations %}
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-success text-white">
        <i class="bi bi-stars me-2"></i>Recommended Backends
      </div>
      <div class="card-body">
        <div class="row">
          {% for rec in recommendations %}
          <div class="col-md-4 mb-3">
            <div class="card h-100 border-success">
              <div class="card-header bg-success bg-opacity-10">
                <h6 class="mb-0">
                  <i class="bi bi-{% if rec.service_type == 'public' %}cloud{% else %}building{% endif %} me-2"></i>
                  {{ rec.name }}
                </h6>
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="badge bg-{% if rec.service_type == 'public' %}info{% else %}success{% endif %}">
                    {{ rec.service_type|upper }}
                  </span>
                  <strong class="text-success">{{ rec.score }}/100</strong>
                </div>

                <div class="progress mb-3" style="height: 6px;">
                  <div class="progress-bar bg-success" style="width: {{ rec.score }}%"></div>
                </div>

                <div class="row small text-muted">
                  <div class="col-6">
                    <i class="bi bi-cpu"></i> {{ rec.qubits }} qubits
                  </div>
                  <div class="col-6">
                    <i class="bi bi-clock"></i> {{ rec.queue_length }} in queue
                  </div>
                </div>

                <p class="small text-muted mt-2 mb-0">
                  <i class="bi bi-info-circle"></i> {{ rec.recommendation_reason }}
                </p>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Backends Table -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="bi bi-server me-2"></i>Quantum Backends
        </h5>
        <span class="badge bg-light text-dark">{{ public_rows|length + private_rows|length }} backends</span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Qubits</th>
                <th>Queue</th>
                <th>Status</th>
                <th>Estimated Wait</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for backend in public_rows %}
              <tr data-backend="{{ backend.name }}">
                <td>
                  <strong>{{ backend.name }}</strong>
                  {% if backend.status_msg %}
                  <br><small class="text-muted">{{ backend.status_msg }}</small>
                  {% endif %}
                </td>
                <td><span class="badge bg-info">Public</span></td>
                <td>{{ backend.qubits }}</td>
                <td>
                  <span class="backend-queue">{{ backend.queue }}</span>
                  {% if backend.queue > 0 %}
                  <div class="progress mt-1" style="height: 4px; width: 60px;">
                    <div class="progress-bar
                      {% if backend.queue == 0 %}bg-success
                      {% elif backend.queue < 5 %}bg-info
                      {% elif backend.queue < 10 %}bg-warning
                      {% else %}bg-danger{% endif %}"
                      style="width: {{ backend.queue_percentage }}%">
                    </div>
                  </div>
                  {% endif %}
                </td>
                <td>
                  <span class="badge backend-status
                    {% if 'Available' in backend.status %}bg-success{% else %}bg-danger{% endif %}">
                    {{ backend.status }}
                  </span>
                </td>
                <td>{{ backend.estimated_wait }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary"
                          data-backend="{{ backend.name }}"
                          onclick="selectBackend('{{ backend.name }}')">
                    <i class="bi bi-play-circle"></i> Use
                  </button>
                </td>
              </tr>
              {% endfor %}

              {% for backend in private_rows %}
              <tr data-backend="{{ backend.name }}">
                <td>
                  <strong>{{ backend.name }}</strong>
                  {% if backend.status_msg %}
                  <br><small class="text-muted">{{ backend.status_msg }}</small>
                  {% endif %}
                </td>
                <td><span class="badge bg-success">Private</span></td>
                <td>{{ backend.qubits }}</td>
                <td>
                  <span class="backend-queue">{{ backend.queue }}</span>
                  {% if backend.queue > 0 %}
                  <div class="progress mt-1" style="height: 4px; width: 60px;">
                    <div class="progress-bar
                      {% if backend.queue == 0 %}bg-success
                      {% elif backend.queue < 5 %}bg-info
                      {% elif backend.queue < 10 %}bg-warning
                      {% else %}bg-danger{% endif %}"
                      style="width: {{ backend.queue_percentage }}%">
                    </div>
                  </div>
                  {% endif %}
                </td>
                <td>
                  <span class="badge backend-status
                    {% if 'Available' in backend.status %}bg-success{% else %}bg-danger{% endif %}">
                    {{ backend.status }}
                  </span>
                </td>
                <td>{{ backend.estimated_wait }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-success"
                          data-backend="{{ backend.name }}"
                          onclick="selectBackend('{{ backend.name }}', true)">
                    <i class="bi bi-play-circle"></i> Use
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Job Submission Modal -->
<div class="modal fade" id="jobModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('dashboard') }}">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="bi bi-plus-circle me-2"></i>Submit Quantum Job
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <!-- Backend Selection -->
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Backend</label>
              <select class="form-select" name="backend" required>
                <option value="">-- Select Backend --</option>
                {% for backend in public_backends %}
                  <option value="{{ backend }}">{{ backend }} (Public)</option>
                {% endfor %}
                {% for backend in private_backends %}
                  <option value="{{ backend }}">{{ backend }} (Private)</option>
                {% endfor %}
              </select>
            </div>

            <!-- Circuit Type -->
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Circuit Type</label>
              <select class="form-select" name="circuit_type">
                <option value="single_qubit">Single Qubit (H gate)</option>
                <option value="bell">Bell State (Entanglement)</option>
                <option value="ghz">GHZ State (3-qubit)</option>
              </select>
            </div>

            <!-- Shots -->
            <div class="col-md-4 mb-3">
              <label class="form-label fw-semibold">Shots</label>
              <input type="number" class="form-control" name="shots" value="100" min="1" max="1000">
            </div>

            <!-- Priority -->
            <div class="col-md-4 mb-3">
              <label class="form-label fw-semibold">Priority</label>
              <select class="form-select" name="priority">
                <option value="low">Low</option>
                <option value="normal" selected>Normal</option>
                <option value="high">High</option>
              </select>
            </div>

            <!-- Tags -->
            <div class="col-md-4 mb-3">
              <label class="form-label fw-semibold">Tags (comma-separated)</label>
              <input type="text" class="form-control" name="tags" placeholder="tag1,tag2">
            </div>

            <!-- Options -->
            <div class="col-12 mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="use_private" id="usePrivate">
                <label class="form-check-label" for="usePrivate">Use Private Instance</label>
              </div>
              {% if aer_available %}
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="use_aer" id="useAer">
                <label class="form-check-label" for="useAer">Local Simulation (Aer)</label>
              </div>
              {% endif %}
              <!-- NEW: Estimator Mode Option -->
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="use_estimator" id="useEstimator">
                <label class="form-check-label" for="useEstimator">
                  Estimator Mode (for expectation values)
                </label>
              </div>
            </div>

            <!-- Estimator Mode Info (hidden by default) -->
            <div class="col-12 mb-3" id="estimatorInfo" style="display: none;">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Estimator Mode:</strong> This mode calculates expectation values using Pauli observables.
                Ideal for algorithms like VQE that require expectation values rather than measurement counts.
                <br>
                <small class="text-muted">
                  • Bell State: ZZ observable<br>
                  • GHZ State: ZZZ observable<br>
                  • Single Qubit: Z observable
                </small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-play-circle me-2"></i>Run Job
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function selectBackend(backendName, isPrivate = false) {
    const modal = new bootstrap.Modal(document.getElementById('jobModal'));
    const backendSelect = document.querySelector('select[name="backend"]');
    const privateCheckbox = document.querySelector('input[name="use_private"]');

    backendSelect.value = backendName;
    if (isPrivate) {
      privateCheckbox.checked = true;
    }

    modal.show();
  }

  // Toggle estimator info based on checkbox state
  document.addEventListener('DOMContentLoaded', function() {
    const estimatorCheckbox = document.querySelector('input[name="use_estimator"]');
    const estimatorInfo = document.getElementById('estimatorInfo');
    const aerCheckbox = document.querySelector('input[name="use_aer"]');

    if (estimatorCheckbox && estimatorInfo) {
      estimatorCheckbox.addEventListener('change', function() {
        estimatorInfo.style.display = this.checked ? 'block' : 'none';

        // Disable Aer when estimator is selected (they're incompatible)
        if (this.checked && aerCheckbox) {
          aerCheckbox.checked = false;
          aerCheckbox.disabled = true;
        } else if (aerCheckbox) {
          aerCheckbox.disabled = false;
        }
      });
    }

    // Disable estimator when Aer is selected
    if (aerCheckbox) {
      aerCheckbox.addEventListener('change', function() {
        const estimatorCheckbox = document.querySelector('input[name="use_estimator"]');
        if (this.checked && estimatorCheckbox) {
          estimatorCheckbox.checked = false;
          estimatorCheckbox.disabled = true;
          estimatorInfo.style.display = 'none';
        } else if (estimatorCheckbox) {
          estimatorCheckbox.disabled = false;
        }
      });
    }
  });

  // Initialize real-time updates
  setInterval(updateBackendStatuses, 30000);
  setTimeout(updateBackendStatuses, 1000);
</script>
{% endblock %}
<!-- [file content end] -->